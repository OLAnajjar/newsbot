import feedparser
import requests
from datetime import datetime
import schedule
import time
import os

# ============= ุฅุนุฏุงุฏ ุงููุตุงุฏุฑ ============
feeds = {
    "SANA": {"url": "https://www.sana.sy/feed/", "type": "ุฑุณูู", "city": None},
    "SAMA TV": {"url": "https://www.sama-tv.net/rss", "type": "ุฑุณูู", "city": None},
    "ุนูุจ ุจูุฏู": {"url": "https://www.enabbaladi.net/feed/", "type": "ูุณุชูู", "city": None},
    "SNHR": {"url": "https://news.snhr.org/feed/", "type": "ุญูููู", "city": None},
    "SOHR": {"url": "https://www.syriahr.com/en/feed/", "type": "ุญูููู", "city": None},
    "Al Jazeera โ ุณูุฑูุง": {"url": "https://www.aljazeera.com/where/syria/", "type": "ุฏููู", "city": None}
}

# ============= ูููุงุช ุงูุชุตููู ุงูููุณุนุฉ ============
categories = {
    "ุฃููู": [
        "ุฏูุฑูุงุช ุงูุฃูู", "ุญูุงุฌุฒ", "ุจูุงุบุงุช", "ุณุฑูุฉ", "ูุทููุจูู", "ุญููุฉ ุชูุชูุด", "ุดุจูุฉ", "ุงุนุชูุงู",
        "ุชูุฑูุจ", "ุงุนุชูุงูุงุช", "ูุฑุงูุจุฉ", "ูุทููุจ", "ุญูุงุฏุซ", "ูุชุทุฑู", "ุฎูุงูุง", "ุนูุงุตุฑ ุฃูููุฉ"
    ],
    "ุนุณูุฑู": [
        "ุชุญุฑูุงุช ุนุณูุฑูุฉ", "ุฌุจูุงุช", "ุชุจุงุฏู ุงุณุชูุฏุงูุงุช", "ูุฏูุนูุฉ", "ูุฌูู", "ููุงุฌูุงุช", "ุฑุตุฏ",
        "ููุงุช", "ุงูุชุดุงุฑ", "ุฑุตุฏ ุทุงุฆุฑุงุช ุงุณุชุทูุงุน", "ุชููุถุน", "ุฎุทูุท ุชูุงุณ"
    ],
    "ุงูุชุตุงุฏู": [
        "ุฃุณุนุงุฑ", "ุงูุชุตุงุฏ", "ูุญูู", "ุฏูุงุฌู", "ุณุนุฑ ุงูุตุฑู", "ุงูุฃุณูุงู", "ุฑููุฏ", "ููุงุฏ ุจูุงุก",
        "ุฅุณููุช", "ูุญุฑููุงุช", "ุฃุฌูุฑ", "ุดุฑุงุก", "ุดุญู", "ุฏููู", "ุฎุจุฒ", "ุบุฐุงุฆูุฉ", "ุฅูุชุงุฌ", "ุชูุฑูุฏ",
        "ุตูุงุฑูุฌ", "ุงูููุท", "ุชุณุนูุฑ", "ุชุฌุงุฑุฉ"
    ],
    "ุงุฌุชูุงุนู": [
        "ุงุฒุฏุญุงู", "ูุฑูุฑ", "ุญุฑูุฉ ุงูููู", "ุฅุตุงุจุงุช", "ูุณุชุดูู", "ูุฑูุฒ ุตุญู", "ุฃูุฑุงุถ ููุณููุฉ",
        "ูุงุฒุญูู", "ูุณุงุนุฏุงุช", "ููุงู", "ููุฑุจุงุก", "ุชูููู", "ุตูุงูุฉ", "ุฎุฏูุงุช", "ุฑูุงุชุจ", "ุงุญุชุฌุงุฌุงุช",
        "ุงููุฏุงุฑุณ", "ูุฌุชูุน", "ุณูุงู", "ุฃูุงูู"
    ],
    "ุฎุงุฑุฌู": [
        "ุฏูููุฉ", "ุณููุฑ", "ููุงูุถุงุช", "ุนููุจุงุช", "ุงูุฃูู", "ุฑูุณูุง", "ุฅูุฑุงู", "ุฃูุฑููุง", "ุชุฑููุง",
        "ุชุฏุฎู", "ุงุชูุงู", "ุนูุงูุงุช", "ููุงูุถุงุช ุฏูููุฉ"
    ],
    "ุญูููู": [
        "ูุฒุงุฑุฉ", "ูุฒุฑุงุก", "ูุฌูุณ ูุฒุฑุงุก", "ูุฑุงุฑ ุญูููู", "ุญูููุฉ", "ูุดุฑูุน", "ูุฒุงุฑุฉ ุงูุฏุงุฎููุฉ",
        "ูุฒุงุฑุฉ ุงูุตุญุฉ", "ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ", "ูุฒุงุฑุฉ ุงูุชุนููู", "ูุฒุงุฑุฉ ุงูุงูุชุตุงุฏ", "ูุฒุงุฑุฉ ุงููุงููุฉ",
        "ูุฒุงุฑุฉ ุงูููุท", "ูุฒุงุฑุฉ ุงูููุฑุจุงุก", "ูุฒุงุฑุฉ ุงูููู", "ูุฒุงุฑุฉ ุงูุดุคูู ุงูุงุฌุชูุงุนูุฉ",
        "ูุฒุงุฑุฉ ุงูุฎุงุฑุฌูุฉ", "ุงุฌุชูุงุน ุญูููู", "ุจูุงู ุฑุณูู", "ุชูุฌูู", "ุฅุฏุงุฑุฉ", "ูุฏูุฑ", "ูุฏูุฑูุฉ",
        "ููุฆุฉ", "ููุงูุฉ", "ูุฑุงุฑ", "ุชุดุฑูุน", "ูุงููู", "ูุชุงุจุนุฉ", "ุชูููุฐ", "ุชูุณูู", "ููุงุฒูุฉ",
        "ุฎุทุฉ", "ุชุทููุฑ", "ุฅุตูุงุญ", "ุฅุฌุฑุงุกุงุช", "ูุดุงุฑูุน", "ุจุฑูุงูุฌ", "ุชุนูููุงุช", "ุชูุธูู", "ูุฌูุฉ",
        "ุชูุฑูุฑ ุญูููู"
    ]
}

# ============= ูุงุฆูุฉ ุงููุฏู ============
cities = [
    "ุฏูุดู", "ุงููุฒุฉ", "ุงูููุฏุงู", "ุงูุชุถุงูู", "ููุฑุณูุณุฉ", "ุฌุณุฑ ุงูุฑุฆูุณ", "ุฑูู ุฏูุดู",
    "ุญุฑุณุชุง", "ุฏููุง", "ุงูููููู", "ุตุญูุงูุง", "ุงูุฃุดุฑููุฉ", "ุญูุจ", "ุงููุฏููุฉ ุงููุฏููุฉ",
    "ุงูุฒูุฑุงูู", "ุฅุฏูุจ", "ูุฎููุงุช ุฃุทูุฉ", "ุญูุต", "ุงููุนุฑ", "ุญูุงุฉ", "ุงููุงุฐููุฉ", "ุทุฑุทูุณ",
    "ุงูุฑูุฉ", "ุฏูุฑ ุงูุฒูุฑ", "ุงูุจูููุงู", "ุงูุญุณูุฉ", "ุฏุฑุนุง", "ุงููููุทุฑุฉ", "ุงูุณููุฏุงุก"
]


# ============= ุฏูุงู ูุณุงุนุฏุฉ ============
def classify(text):
    text_lower = text.lower()
    for cat, words in categories.items():
        for word in words:
            if word.lower() in text_lower:
                return cat
    return "ุบูุฑ ูุญุฏุฏ"


def extract_city(text):
    text_lower = text.lower()
    for city in cities:
        if city.lower() in text_lower:
            return city
    return "ุบูุฑ ูุญุฏุฏ"


# ============= ุฅุนุฏุงุฏ ููู ุฑูุงุจุท ุงูุฃุฎุจุงุฑ ุงููุฑุณูุฉ ============
SENT_FILE = "sent_links.txt"
if os.path.exists(SENT_FILE):
    with open(SENT_FILE, "r", encoding="utf-8") as f:
        sent_links = set(line.strip() for line in f.readlines())
else:
    sent_links = set()

# ============= ุฅุฑุณุงู ุงูุฃุฎุจุงุฑ ============
BOT_TOKEN = "8052608382:AAG5S6nhpzTxIRfW3G69_c_y_gDW_u5RgE4"
CHAT_ID = "5246486895"


def send_news():
    global sent_links
    for source, info in feeds.items():
        feed = feedparser.parse(info["url"])
        for entry in feed.entries:
            link = entry.link
            if link in sent_links:
                continue  # ุชุฎุทู ุงูุฃุฎุจุงุฑ ุงููุฏููุฉ

            title = entry.title
            summary = entry.get("summary", "")
            full_text = f"{title}\n\n{summary}"
            category = classify(full_text)
            city = extract_city(full_text)

            message = (
                f"๐ฐ {title}\n"
                f"๐๏ธ ุงููุฏููุฉ: {city}\n"
                f"๐ ุงูุชุตููู: {category}\n"
                f"๐ ุงููุตุฏุฑ: {source}\n"
                f"๐ ุงูุฑุงุจุท: {link}\n"
            )

            url_api = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
            requests.post(url_api, data={"chat_id": CHAT_ID, "text": message})

            sent_links.add(link)
            with open(SENT_FILE, "a", encoding="utf-8") as f:
                f.write(link + "\n")  # ุญูุธ ุงูุฑุงุจุท ูุชุฌูุจ ุงูุชูุฑุงุฑ ูุงุญููุง

            print(f"โ ุชู ุฅุฑุณุงู ุงูุฎุจุฑ: {title}")
            time.sleep(3)  # ุชุฃุฎูุฑ 3 ุซูุงูู ุจูู ุงูุฃุฎุจุงุฑ ูุชุฌูุจ ุงูุณุฑุนุฉ ุงููุจูุฑุฉ


# ============= ุฅุฑุณุงู ุฃูู ุฎุจุฑ ููุฑ ุงูุชุดุบูู ============
send_news()

# ============= ุฌุฏููุฉ ูู 10 ุฏูุงุฆู ============
schedule.every(10).minutes.do(send_news)

print("๐ ุงูุจูุช ูุนูู ุงูุขู ูุฅุฑุณุงู ุขุฎุฑ ุงูุฃุฎุจุงุฑ ุงูุฌุฏูุฏุฉ ูู 10 ุฏูุงุฆู...")

while True:
    schedule.run_pending()
    time.sleep(1)
